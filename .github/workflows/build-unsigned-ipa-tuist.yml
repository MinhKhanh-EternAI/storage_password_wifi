name: "CI - Xcode/Tuist unsigned IPA pipeline"

on:
  push:
    branches: ['**']       # chạy trên mọi nhánh
  pull_request:
    branches: ['**']       # chạy khi mở PR từ bất kỳ nhánh nào
  workflow_dispatch:

concurrency:
  group: ci-xcode-tuist-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: macos-15  # macOS 15 với Xcode 16

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show Xcode / macOS
        run: |
          xcodebuild -version
          sw_vers

      - name: Install Mise and Tuist
        run: |
          curl https://mise.jdx.dev/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          eval "$(/Users/runner/.local/bin/mise activate bash)"
          mise install tuist
          mise use tuist@latest
          which tuist
          tuist version

      - name: Normalize & validate Info.plist
        shell: bash
        run: |
          set -euo pipefail
          if [[ ! -f Info.plist ]]; then
            echo "❌ Missing Info.plist"; exit 1
          fi
          python3 - <<'PY'
          from pathlib import Path
          p = Path('Info.plist')
          b = p.read_bytes()
          if b.startswith(b'\xef\xbb\xbf'):
              b = b[3:]
          b = b.replace(b'\r\n', b'\n').replace(b'\r', b'\n')
          p.write_bytes(b)
          PY
          plutil -convert xml1 Info.plist
          plutil -lint Info.plist

      - name: Tuist generate
        run: |
          eval "$(/Users/runner/.local/bin/mise activate bash)"
          tuist generate --no-open

      - name: Build unsigned .app
        shell: bash
        run: |
          set -euo pipefail
          xcodebuild \
            -workspace ./WiFiOffline.xcworkspace \
            -scheme WiFiOffline \
            -configuration Release \
            -sdk iphoneos \
            -destination generic/platform=iOS \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO CODE_SIGNING_IDENTITY= \
            -derivedDataPath build \
            clean build

      - name: Package unsigned IPA
        shell: bash
        run: |
          set -euo pipefail
          APP_PATH=$(find build/Build/Products/Release-iphoneos -maxdepth 1 -type d -name "*.app" -print -quit || true)
          echo "APP_PATH=$APP_PATH"
          [[ -n "${APP_PATH:-}" && -d "$APP_PATH" ]]

          APP_NAME=$(basename "$APP_PATH" .app)
          PLIST="$APP_PATH/Info.plist"
          /usr/libexec/PlistBuddy -c 'Print :CFBundleIdentifier' "$PLIST"
          /usr/libexec/PlistBuddy -c 'Print :CFBundleExecutable' "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleExecutable string ${APP_NAME}" "$PLIST"
          /usr/libexec/PlistBuddy -c 'Print :CFBundleShortVersionString' "$PLIST" || /usr/libexec/PlistBuddy -c 'Add :CFBundleShortVersionString string 1.0' "$PLIST"
          /usr/libexec/PlistBuddy -c 'Print :CFBundleVersion' "$PLIST" || /usr/libexec/PlistBuddy -c 'Add :CFBundleVersion string 1' "$PLIST"

          rm -rf Payload *.ipa
          mkdir -p Payload
          cp -R "$APP_PATH" "Payload/${APP_NAME}.app"

          IPA_NAME="${APP_NAME}-unsigned.ipa"
          ditto -ck --sequesterRsrc --keepParent Payload "$IPA_NAME"

          unzip -l "$IPA_NAME" | sed -n '1,100p'
          ls -lah "$IPA_NAME"

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: WiFiOffline-unsigned
          path: "*.ipa"
          if-no-files-found: error
